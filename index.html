<!DOCTYPE html>
<html>
<head>
<script src="blockly_compressed.js"></script>
<script src="blocks_compressed.js"></script>
<script src="javascript_compressed.js"></script>
<script src="msg/js/en.js"></script>
<script src="flytxt/bbm.js"></script>
<script src="flytxt/bbm_consts.js"></script>
<script src="flytxt/blocks/flytxt.js"></script>
<script src="flytxt/blocks/tpblock.js"></script>
<script src="flytxt/blocks/test.js"></script>
<script src="flytxt/blocks/tplist.js"></script>
<script src="flytxt/blocks/ternary.js"></script>
<script src="flytxt/blocks/tpblock_extractor.js"></script>
<script src="flytxt/generators/javascript/tpblock.js"></script>
<!-- <script src="../closure-library/closure/goog/base.js"></script> -->

 <meta charset="utf-8">
<title>Blockly Testing</title>
<style type="text/css">
#blocklyDiv {
  height: 960px;
}
</style>
</head>
<body>
  <button id="gen">Generate</button>
 <div id="blocklyDiv" ></div>

  <script>
    var sample = '0003657095|1|2|09-19-16|20:00:45.0|||09-19-16|20:00:45.8|98956|919712569423|0|9141069913091232|17|pps|16|52|919712569423|98956|Asia/Calcutta|0.0000|2|0.0000|1|0.0000|2|9141069913091232||0|0|0|0||404050220707456|0|313|0.0000|0.0000|0.0000|0|0|0|0.00|0|124@@@@@@|12424@@@@|0|0.0000|0|0.0000|0|0.0000|0|0.0000|0|0.0000|0|0.0000|0|0.0000|0|0.0000|0|0.0000|0|0.0000|0|0.0000|0|0.0000|0|0.0000|0|0.0000|0|0.0000|||1|0|36||0|919825401010|404050220707456|101|1||||||||17|0|22|1*CORE BALANCE*10.4490*0.0000*1*+*2*0*2*V2V_LOCAL_BAL*0.0000*0.0000*2*+*2*0*3*SMS_BALANCE*0.0000*0.0000*4*+*2*0*4*V2V_NIGHT_MINUTES*0.0000*0.0000*2*+*2*0*5*STD_MINUTES*0.0000*0.0000*2*+*2*0*6*V2V_LOCAL_MINUTES*0.0000*0.0000*2*+*2*0*7*M2M_LOCAL*0.0000*0.0000*2*+*2*0*8*Minutes_LOCAL*0.0000*0.0000*2*+*2*0*9*SMS_STD_LO*0.0000*0.0000*4*+*2*0*10*LOCAL_NIGHT_MINUTES*0.0000*0.0000*2*+*2*0*11*LOCAL_STD_BAL*0.0000*0.0000*2*+*2*0*22*CORE2_BALANCE*0.0000*0.0000*1*+*2*0*42*V2O_BAL*0.0000*0.0000*2*+*2*0*62*DUMMY_SMS*0.0000*0.0000*4*+*2*0*63*V2V_LOC_NAT_SMS*0.0000*0.0000*4*+*2*0*65*ROAM_INTL_IC_FREE*0.0000*0.0000*2*+*2*0*66*ERW_LOCAL_MOBILE_SECS*0.0000*0.0000*2*+*2*0*67*CallDropV2VL*0.0000*0.0000*2*+*2*0*68*ERW_SMS*0.0000*0.0000*4*+*2*0*69*ERW_NIGHT_V2V_SECS*0.0000*0.0000*2*+*2*0*70*ERW_TALKTIME*0.0000*0.0000*1*+*2*0*73*FLEX_BAL*0.0000*0.0000*1*+*2*0*|1|5*ACCUM_SMS_100*0.0000*0.0000*|0||401D413F0BE4D1|1|0|3|0.0000||';

    var gen = document.getElementById('gen');
    var blocklyDiv = document.getElementById('blocklyDiv');
    var workspace = Blockly.inject(blocklyDiv);
    window.addEventListener('resize', onresize, true);
    Blockly.svgResize(workspace);

    // Complex init

    var xmlInit = '<xml xmlns="http://www.w3.org/1999/xhtml"><block type="flytxt" id="u0m~iVrRcWYMEM2B2{rJ" x="99" y="91"><field name="operation">LocalFile</field><field name="headers">TRUE</field><value name="lineName"><block type="lists_create_with_extract" id="p(?^da/A)56,z#lCK3#/" movable="false"><value name="ADD0"><block type="delimiter" id="qXV?+vyj8|Q3eT-;tsQR"><mutation items="2"></mutation><field name="delim">,</field><value name="next_marker_1"><block type="field_extractor" id=")QXaB3,!m$X9r,4[Bazr"><field name="NAME">1</field><field name="operation">string</field><field name="VAR">__temp1</field></block></value><value name="next_marker_0"><block type="field_extractor" id="YxJMw;H(U,kwuOu8DqC8"><field name="NAME">2</field><field name="operation">string</field><field name="VAR">__temp2</field></block></value></block></value></block></value><value name="fileName"><block type="lists_create_with_extract" id="{{,nmR,%`Cv^{tD%ZeU{" movable="false"><value name="ADD0"><block type="delimiter" id="as1b:A[6,ur?D7Oo{Wb3"><mutation items="1"></mutation><field name="delim">*</field></block></value></block></value><statement name="transform"><block type="dynamic" id="/nq[tj.o%EYk2hsO)QZX"><mutation operation="endsWith"></mutation><field name="m1">__temp1</field><field name="operation">endsWith</field><field name="m2">__temp2</field><field name="VAR">__temp3</field><next><block type="controls_if" id="6w$0`N:vRV`)!uL;E-v}"><value name="IF0"><block type="test" id="L0gv38GG6+U)OWB./SI6"><mutation testattr="containsIgnoreCase"></mutation><field name="m1">__temp2</field><field name="operation">containsIgnoreCase</field><field name="m2">__temp2</field></block></value><statement name="DO0"><block type="dynamic" id="Hr}u8*{B}af@3Bg(B_n_"><mutation operation="containsIgnoreCase"></mutation><field name="m1">__temp2</field><field name="operation">containsIgnoreCase</field><field name="m2">__temp2</field><field name="VAR">__temp5</field></block></statement></block></next></block></statement><value name="store_stream"><block type="lists_create_with_stream" id="t$zhGi(*AKu,-o`GImaM" movable="false"><value name="ADD0"><block type="event_field" id="c~3bV=xl!`OK,o]m6L88"><field name="m1">__temp1</field><field name="m2">__temp1</field><field name="dataType">AGG_AND_TIME</field><field name="fieldType">SECONDS</field><field name="aggragation">TRUE</field><field name="m5">__temp__1</field><field name="m3">__temp1</field><field name="m4">__temp1</field><field name="VAR">__temp4</field></block></value></block></value><value name="store_batch"><block type="lists_create_with_batch" id="klsocCP6=vQzfSf]]X?}" movable="false"><value name="ADD0"><block type="output_field" id="~F5^?(MU8{;k/~ly{05%"><field name="VAR">__temp3</field></block></value></block></value></block></xml>';
                 var xmlDom = Blockly.Xml.textToDom(xmlInit);
                Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xmlDom);

    // Simple init

    // var xmlInit = '<xml xmlns="http://www.w3.org/1999/xhtml"><block type="extractor" id="D-i{Q5j{]PJ!5f.@f^S^" deletable="false" x="247" y="290"><value name="line"><block type="delimiter" id="kEgfrfbJc;)[aRxq`RI5"><mutation items="2"></mutation><field name="delim">|</field><value name="next_marker_1"><block type="field_extractor" id="qrCQLpWB|K{B|O)%-d.+"><field name="NAME">1</field><field name="operation">string</field><field name="VAR">variable_1</field></block></value></block></value><next><block type="transform" id="`#{siG=4Z=W{9fzG7~Xj" deletable="false"><next><block type="store" id="x6tnR`YVMw61kvdnf}`B" deletable="false"><mutation items="2"></mutation><field name="operation">hdfs</field><field name="headers">TRUE</field><value name="ADD0"><block type="output_field" id="V12eTWLr65|H(RlA1`cL"><field name="VAR">variable_1</field></block></value></block></next></block></next></block></xml>';

    gen.addEventListener('click', function() {
      var count = 0;
      Blockly.JavaScript.initFunctions = [];
      // Blockly.JavaScript.initFunctions = ['setInputFileName("TestScript");'];
      // Blockly.JavaScript.initFunctions.push('this.mf.setMaxListSize(' + (count + 4) + ');\n');
      Blockly.JavaScript.variables = [];
      // Blockly.JavaScript.variables.push('private Store store = new ConsoleStore("/tmp/output");\n');
      // Blockly.JavaScript.variables.push('public final String folderName = "/tmp/java/INRecharge/";\n');
      // Blockly.JavaScript.variables.push('public final String regex = "(.*)";\n');

      Blockly.JavaScript.extractPhase = '';
      Blockly.JavaScript.translatePhase = '';
      Blockly.JavaScript.storePhase = '';
      Blockly.JavaScript.workspaceToCode(Blockly.getMainWorkspace());
      var output ='';
      Blockly.JavaScript.variables.forEach(function(variable) {
        if (variable.indexOf('boolean ') != -1) {
          count++;
        } else if (variable.indexOf('Marker ') != -1) {
          count++;
        }
      });
      Blockly.JavaScript.initFunctions.push('this.mf.setMaxListSize(' + (count + 4) + ');\n');
      output+= "Variables\n";
      output+= "--------------------\n";
      output+= Blockly.JavaScript.variables.join('\n')+'\n';
      output+= "--------------------\n";
      output+= "Inits\n";
      output+= "--------------------\n";
      output+= Blockly.JavaScript.initFunctions.join('\n')+'\n';
      output+= "--------------------\n";
      output+= "Extraction\n";
      output+= "--------------------\n";
      output+= Blockly.JavaScript.extractPhase+'\n';
      output+= "--------------------\n";
      output+= "Transform\n";
      output+= "--------------------\n";
      output+= Blockly.JavaScript.translatePhase+'\n';
      output+= "--------------------\n";
      output+= "Store\n";
      output+= "--------------------\n";
      output+= Blockly.JavaScript.storePhase+'\n';
      output+= "--------------------\n";

      console.log(output)
      var http = new XMLHttpRequest();
      var url = 'http://192.168.14.95:9000/compileNtest/';
      http.onreadystatechange = function() {//Call a function when the state changes.  
        if(http.readyState == 4 && http.status == 200) {
          alert(http.responseText);
        }
      }
      http.open('POST', url, true);
      // http.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
      // http.setRequestHeader('Accept', 'application/json');
      // http.overrideMimeType("text/js; charset=ISO-8859-1")
      http.setRequestHeader('Content-Type', 'application/json');
      http.send(JSON.stringify({
        name: 'TestScript',
        init: Blockly.JavaScript.initFunctions.join('\n'),
        absProcessor: Blockly.JavaScript.variables.join('\n'),
        extract: Blockly.JavaScript.extractPhase,
        transformation: Blockly.JavaScript.translatePhase,
        store: Blockly.JavaScript.storePhase,
        type: 'single',
        sample: sample
      }));
    });
    Blockly.Blocks.Manager.ws = Blockly.getMainWorkspace();
    Blockly.getMainWorkspace().addChangeListener(Blockly.Blocks.Manager.changeListener.bind(bbm));
    bbm.init();
  </script>
</body>
</html>
